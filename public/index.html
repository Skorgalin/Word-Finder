<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Word Finder Game</title>

<link rel="stylesheet" href="style.css">
</head>

<body>

<header>
  <h2>Word Finder Game</h2>
</header>

<div id="login">
  <input id="email" type="email" placeholder="E-Mail" autocomplete="username" required>
  <input id="password" type="password" placeholder="Passwort" autocomplete="current-password" required>
  <button id="registerBtn">Registrieren</button>
  <button id="loginBtn" style="display:none;">Login</button>
</div>

<div id="game" style="display:none;">
  <input id="word" placeholder="Wort eingeben">
  <button onclick="submitItem()">OK</button>

  <button onclick="toggleFound()">Found Items</button>
  <button id="adminBtn" style="display:none;" onclick="askAdminPassword()">Admin</button>
  <button onclick="logout()">Logout</button>

  <div id="foundItems"></div>

  <div id="adminPanel">
    <h3>Admin Dashboard</h3>

    <input id="announceText" placeholder="Ankündigung">
    <button onclick="sendAnnouncement()">Senden</button>

    <hr>

    <input id="adminSearchInput" placeholder="Output eingeben">
    <button onclick="adminSearch()">OK</button>
    <div id="adminSearchResult"></div>

    <hr>

    <button onclick="loadPlayers()">Spieler verwalten</button>
    <div id="playersList"></div>
    <div id="playerAdminPanel"></div>
  </div>
</div>

<div id="announcements"></div>

<script src="/socket.io/socket.io.js"></script>
<script src="player.js"></script>
<script src="admin.js"></script>

<script>
const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const loginBtn = document.getElementById("loginBtn");
const registerBtn = document.getElementById("registerBtn");

let email = "";
let isAdmin = false;
let adminUnlocked = false;

const socket = io();

function checkEmail(){
  if(!emailInput.value) return;

  fetch("/checkEmail",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ email: emailInput.value })
  })
  .then(r=>r.json())
  .then(d=>{
    loginBtn.style.display = d.exists ? "inline" : "none";
    registerBtn.style.display = d.exists ? "none" : "inline";
  });
}

emailInput.addEventListener("input", checkEmail);
emailInput.addEventListener("change", checkEmail);

registerBtn.onclick = ()=>{
  fetch("/register",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      email: emailInput.value,
      password: passwordInput.value
    })
  })
  .then(r=>r.json())
  .then(d=>{
    if(d.ok){
      enterGame(d.admin);
    } else {
      alert("Registrierung fehlgeschlagen");
    }
  });
};

loginBtn.onclick = ()=>{
  fetch("/login",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      email: emailInput.value,
      password: passwordInput.value
    })
  })
  .then(r=>r.json())
  .then(d=>{
    if(d.ok){
      enterGame(d.admin);
    } else {
      alert("Falsches Passwort");
    }
  });
};

function enterGame(admin){
  email = emailInput.value;
  isAdmin = admin;
  adminUnlocked = false;

  document.getElementById("login").style.display="none";
  document.getElementById("game").style.display="flex";

  if(isAdmin){
    document.getElementById("adminBtn").style.display="inline";
  }

  initPlayer(email);

  emailInput.value="";
  passwordInput.value="";
}

function logout(){
  socket.emit("player:offline",{ email });
  email="";
  isAdmin=false;
  adminUnlocked=false;

  document.getElementById("game").style.display="none";
  document.getElementById("login").style.display="flex";

  emailInput.value="";
  passwordInput.value="";
  document.getElementById("foundItems").innerHTML="";
}

function submitItem(){
  const input=document.getElementById("word").value;
  if(!input) return;

  fetch("/submitItem",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ email, input })
  })
  .then(r=>r.json())
  .then(d=>{
    if(d.ok){
      notifyItemFound(d.input, d.output);

      const div=document.createElement("div");
      div.textContent = d.input+" → "+d.output+(d.firstDiscovery?" (First Discovery)":"");
      document.getElementById("foundItems").prepend(div);

      document.getElementById("word").value="";
    }
  });
}

function toggleFound(){
  const f=document.getElementById("foundItems");
  f.style.display = f.style.display==="none"?"block":"none";
}

function askAdminPassword(){
  if(adminUnlocked){
    adminPanel.style.display =
      adminPanel.style.display==="none"?"block":"none";
    return;
  }

  const pw=prompt("Admin Passwort:");
  if(pw==="X9$QvR7!eM2#A8wK@C"){
    adminUnlocked=true;
    document.getElementById("adminPanel").style.display="block";
  } else {
    alert("Falsches Passwort");
  }
}

socket.on("announcement",data=>{
  const ann=document.createElement("div");
  ann.className="announcement";
  ann.textContent=data.text;
  document.getElementById("announcements").appendChild(ann);
  setTimeout(()=>ann.remove(),5000);
});

function sendAnnouncement(){
  if(!adminUnlocked) return;
  const text=document.getElementById("announceText").value;
  socket.emit("adminAnnouncement",{text,password:"X9$QvR7!eM2#A8wK@C"});
  document.getElementById("announceText").value="";
}

function adminSearch(){
  const query=document.getElementById("adminSearchInput").value;

  fetch("/adminSearch",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ query })
  })
  .then(r=>r.json())
  .then(d=>{
    if(d.ok){
      const res=document.getElementById("adminSearchResult");
      res.textContent = d.input+" → "+d.output;
    }
  });
}

function loadPlayers(){
  socket.emit("admin:getPlayers");
}

socket.on("admin:playersList",(players)=>{
  const list=document.getElementById("playersList");
  list.innerHTML="";
  players.forEach(p=>{
    const div=document.createElement("div");
    div.textContent=`${p.email} | Online: ${p.online ? "Ja":"Nein"} | Banned: ${p.banned ? p.banned.reason:"Nein"}`;
    list.appendChild(div);
  });
});

socket.on("player:banned",(data)=>{
  document.body.innerHTML=`
    <div style="color:red;text-align:center;margin-top:40px">
      <h2>Du wurdest gebannt</h2>
      <p>${data.reason || ""}</p>
    </div>
  `;
});
</script>

</body>
</html>
