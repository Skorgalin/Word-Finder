<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Word Finder Game</title>
<style>
body{margin:0;background:#0f0f0f;color:white;font-family:Arial}
header{text-align:center;padding:10px;background:#111}
#login,#game{display:flex;flex-direction:column;align-items:center;justify-content:center;height:90vh}
input,button{font-size:18px;margin:5px}
#foundItems{display:none;border:1px solid #444;padding:10px;width:90%;background:#222}
#adminPanel{display:none;border:1px solid #444;padding:10px;width:90%;background:#222}
.announcement{position:fixed;top:10px;left:50%;transform:translateX(-50%);background:white;color:black;padding:6px;border:1px solid black}
</style>
</head>

<body>
<header><h2>Word Finder Game</h2></header>

<div id="login">
  <input id="email" placeholder="E-Mail">
  <input id="password" type="password" placeholder="Passwort" autocomplete="current-password">
  <button id="registerBtn" onclick="register()">Registrieren</button>
  <button id="loginBtn" onclick="login()" style="display:none">Login</button>
</div>

<div id="game" style="display:none">
  <input id="word" placeholder="Wort eingeben">
  <button onclick="submit()">OK</button>
  <button onclick="toggleFound()">Found Items</button>
  <button id="adminBtn" style="display:none" onclick="toggleAdmin()">Admin</button>

  <div id="foundItems"></div>

  <div id="adminPanel">
    <input id="announceText" placeholder="Ankündigung">
    <button onclick="announce()">Senden</button>
    <input id="adminSearchInput" placeholder="Output eingeben">
    <button onclick="adminSearch()">OK</button>
    <div id="adminSearchResult"></div>
  </div>
</div>

<div id="announcements"></div>

<script>
let email="",isAdmin=false,adminUnlocked=false;

/* LOGIN SWITCH */
emailInput = document.getElementById("email");
emailInput.oninput=()=>{
  fetch("/checkEmail",{method:"POST",headers:{"Content-Type":"application/json"},
  body:JSON.stringify({email:emailInput.value})})
  .then(r=>r.json()).then(d=>{
    loginBtn.style.display=d.exists?"inline":"none";
    registerBtn.style.display=d.exists?"none":"inline";
  });
};

function register(){
  email=emailInput.value;
  fetch("/register",{method:"POST",headers:{"Content-Type":"application/json"},
  body:JSON.stringify({email,password:password.value})})
  .then(r=>r.json()).then(d=>{ if(d.ok) enterGame(d.admin); });
}

function login(){
  email=emailInput.value;
  fetch("/login",{method:"POST",headers:{"Content-Type":"application/json"},
  body:JSON.stringify({email,password:password.value})})
  .then(r=>r.json()).then(d=>{ if(d.ok) enterGame(d.admin); });
}

function enterGame(admin){
  isAdmin=admin; adminUnlocked=false;
  login.style.display="none";
  game.style.display="flex";
  if(isAdmin) adminBtn.style.display="inline";
  password.value="";
  loadAnnouncements();
}

/* ITEMS */
function submit(){
  fetch("/submitItem",{method:"POST",headers:{"Content-Type":"application/json"},
  body:JSON.stringify({email,input:word.value})})
  .then(r=>r.json()).then(d=>{
    if(d.ok){
      temp(`${d.input} → ${d.output}`);
      addFound(d.input,d.output,d.firstDiscovery);
      word.value="";
    }
  });
}

function addFound(i,o,f){
  const d=document.createElement("div");
  d.textContent=i+" → "+o+(f?" (First Discovery)":"");
  foundItems.prepend(d);
}

function toggleFound(){
  foundItems.style.display=foundItems.style.display==="none"?"block":"none";
}

function temp(t){
  const d=document.createElement("div");
  d.textContent=t;
  document.body.appendChild(d);
  setTimeout(()=>d.remove(),2000);
}

/* ADMIN */
function toggleAdmin(){
  if(!adminUnlocked){
    const pw=prompt("Admin Passwort:");
    if(pw!=="X9$QvR7!eM2#A8wK@C") return alert("Falsch");
    adminUnlocked=true;
  }
  adminPanel.style.display=adminPanel.style.display==="none"?"block":"none";
}

function adminSearch(){
  fetch("/adminSearch",{method:"POST",headers:{"Content-Type":"application/json"},
  body:JSON.stringify({query:adminSearchInput.value})})
  .then(r=>r.json()).then(d=>{
    adminSearchResult.textContent=`${d.input} → ${d.output}`;
    adminSearchResult.onclick=()=>{
      const n=prompt("Neuer Input:",d.input);
      if(n){
        fetch("/adminChangeInput",{method:"POST",headers:{"Content-Type":"application/json"},
        body:JSON.stringify({oldInput:d.input,newInput:n})});
      }
    };
  });
}

/* ANNOUNCEMENTS */
function announce(){
  fetch("/announce",{method:"POST",headers:{"Content-Type":"application/json"},
  body:JSON.stringify({text:announceText.value,adminPassword:"X9$QvR7!eM2#A8wK@C"})});
}

function loadAnnouncements(){
  setInterval(()=>{
    fetch("/getAnnouncements").then(r=>r.json()).then(d=>{
      d.forEach(a=>{
        const div=document.createElement("div");
        div.className="announcement";
        div.textContent=a.text;
        announcements.appendChild(div);
        setTimeout(()=>div.remove(),5000);
      });
    });
  },1000);
}
</script>
</body>
</html>
