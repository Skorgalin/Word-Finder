<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Word Finder Game</title>
<style>
body { font-family: Arial; margin:0; padding:0; height:100vh; display:flex; flex-direction:column; background:#0f0f0f; color:#fff;}
header {text-align:center; padding:10px; background:#111;}
#game, #login {flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;}
input, button {font-size:18px; margin:5px;}
#foundItems, #adminPanel {border:1px solid #444; padding:10px; margin-top:10px; width:90%; max-height:200px; overflow-y:auto; background:#222;}
.announcement {position:fixed; top:10px; left:50%; transform:translateX(-50%); background:white; color:black; padding:6px 10px; border:1px solid black; animation:fadeOut 5s forwards;}
@keyframes fadeOut {0%{opacity:1} 90%{opacity:1} 100%{opacity:0}}
</style>
</head>
<body>
<header><h2>Word Finder Game</h2></header>

<div id="login">
  <input id="email" placeholder="E-Mail">
  <input id="password" placeholder="Passwort" type="password">
  <button id="registerBtn" onclick="register()">Registrieren</button>
  <button id="loginBtn" onclick="login()" style="display:none;">Login</button>
</div>

<div id="game" style="display:none;">
  <input id="word" placeholder="Wort eingeben">
  <button onclick="submit()">OK</button>
  <button onclick="toggleFound()">Found Items</button>
  <button id="adminBtn" style="display:none;" onclick="toggleAdmin()">Admin</button>

  <div id="foundItems"></div>
  <div id="adminPanel" style="display:none;">
    <h3>Admin Dashboard</h3>
    <input id="announceText" placeholder="Ankündigung">
    <button onclick="announce()">Senden</button>
    <input id="adminSearchInput" placeholder="Output eingeben für Suche">
    <button onclick="adminSearch()">OK</button>
    <div id="adminSearchResult"></div>
  </div>
</div>

<div id="announcements"></div>

<script>
let email = "", isAdmin=false, found=[];

// --- Login/Register Switch ---
document.getElementById("email").addEventListener("input",()=>{
  fetch("/checkEmail",{method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({email:document.getElementById("email").value})})
  .then(r=>r.json()).then(d=>{
    if(d.exists){document.getElementById("loginBtn").style.display="inline"; document.getElementById("registerBtn").style.display="none";}
    else{document.getElementById("loginBtn").style.display="none"; document.getElementById("registerBtn").style.display="inline";}
  });
});

// --- Register ---
function register(){
  email=document.getElementById("email").value;
  const password=document.getElementById("password").value;
  fetch("/register",{method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({email,password})})
  .then(r=>r.json()).then(d=>{
    if(d.ok){enterGame(d.admin);}
    else alert(d.error);
  });
}

// --- Login ---
function login(){
  email=document.getElementById("email").value;
  const password=document.getElementById("password").value;
  fetch("/login",{method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({email,password})})
  .then(r=>r.json()).then(d=>{
    if(d.ok){enterGame(d.admin);}
    else alert(d.error);
  });
}

// --- Enter Game ---
function enterGame(admin){
  isAdmin=admin;
  document.getElementById("login").style.display="none";
  document.getElementById("game").style.display="flex";
  if(isAdmin) document.getElementById("adminBtn").style.display="inline";
  document.getElementById("email").value="";
  document.getElementById("password").value="";
  loadAnnouncements();
}

// --- Logout ---
function logout(){
  document.getElementById("game").style.display="none";
  document.getElementById("login").style.display="flex";
  email=""; found=[]; isAdmin=false;
  document.getElementById("foundItems").innerHTML="";
}

// --- Submit Item ---
function submit(){
  const input=document.getElementById("word").value;
  fetch("/submitItem",{method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({email,input})})
  .then(r=>r.json()).then(d=>{
    if(d.ok){
      found.push({input:d.input, output:d.output, first:d.firstDiscovery});
      showFoundItems(d.input,d.output,d.firstDiscovery);
      document.getElementById("word").value="";
    }
  });
}

function showFoundItems(input,output,first){
  const f=document.getElementById("foundItems");
  const div=document.createElement("div");
  div.textContent=`${input} -> ${output}${first?" (First Discovery)":""}`;
  f.prepend(div);
}

// --- Toggle Found Items ---
function toggleFound(){
  const f=document.getElementById("foundItems");
  f.style.display = f.style.display==="none"?"block":"none";
}

// --- Admin ---
function toggleAdmin(){
  const a=document.getElementById("adminPanel");
  a.style.display=a.style.display==="none"?"block":"none";
}

// --- Admin Announcements ---
function announce(){
  const text=document.getElementById("announceText").value;
  fetch("/announce",{method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({text,adminPassword:"X9$QvR7!eM2#A8wK@C"})})
  .then(r=>r.json()).then(d=>{
    if(d.ok){
      showAnnouncement({id:d.id,text});
      document.getElementById("announceText").value="";
    }
  });
}

// --- Show Announcement ---
function showAnnouncement(a){
  const ann=document.createElement("div");
  ann.className="announcement"; ann.textContent=a.text;
  document.getElementById("announcements").prepend(ann);
  setTimeout(()=>ann.remove(),5000);
}

// --- Load Announcements für Spieler ---
function loadAnnouncements(){
  fetch("/getAnnouncements",{method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({email})})
  .then(r=>r.json()).then(d=>{
    d.forEach(a=>{
      showAnnouncement(a);
    });
  });
}

// --- Admin Search ---
function adminSearch(){
  const query=document.getElementById("adminSearchInput").value;
  fetch("/adminSearch",{method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({query})})
  .then(r=>r.json()).then(d=>{
    if(d.ok){
      const resDiv=document.getElementById("adminSearchResult");
      resDiv.innerHTML=`Input: ${d.input} | Output: ${d.output}`;
      resDiv.onclick=()=> {
        const newInput=prompt("Neuer Input:",d.input);
        if(newInput){
          fetch("/adminChangeInput",{method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({oldInput:d.input,newInput})})
          .then(()=>{resDiv.innerHTML=`Input: ${newInput} | Output: ${d.output}`;});
        }
      };
    }
  });
}
</script>
</body>
</html>
