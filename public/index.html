<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Word Finder Game</title>

<link rel="stylesheet" href="style.css">

<style>
body{
  font-family:Arial;
  margin:0;
  padding:0;
  height:100vh;
  display:flex;
  flex-direction:column;
  background:#0f0f0f;
  color:#fff;
}
header{
  text-align:center;
  padding:10px;
  background:#111;
}
#login,#game{
  flex:1;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
}
input,button{
  font-size:18px;
  margin:5px;
}
#foundItems,#adminPanel{
  border:1px solid #444;
  padding:10px;
  margin-top:10px;
  width:90%;
  max-height:200px;
  overflow-y:auto;
  background:#222;
  display:none;
}
.announcement{
  position:fixed;
  top:10px;
  left:50%;
  transform:translateX(-50%);
  background:white;
  color:black;
  padding:6px 10px;
  border:1px solid black;
  z-index:999;
}
.foundItem{
  border-bottom:1px solid #444;
  padding:4px;
}
.first{
  color:#0f0;
}
</style>
</head>

<body>

<header>
  <h2>Word Finder Game</h2>
</header>

<!-- LOGIN -->
<div id="login">
  <input id="email" type="email" placeholder="E-Mail" required>
  <input id="password" type="password" placeholder="Passwort" required>

  <button id="registerBtn">Registrieren</button>
  <button id="loginBtn" style="display:none;">Login</button>
</div>

<!-- GAME -->
<div id="game" style="display:none;">
  <input id="word" placeholder="Wort eingeben">
  <button onclick="submitItem()">OK</button>

  <button onclick="toggleFound()">Found Items</button>
  <button id="adminBtn" style="display:none;" onclick="askAdminPassword()">Admin</button>
  <button onclick="logout()">Logout</button>

  <div id="foundItems"></div>

  <!-- ADMIN PANEL -->
  <div id="adminPanel">
    <h3>Admin Dashboard</h3>

    <input id="announceText" placeholder="Ankündigung">
    <button onclick="sendAnnouncement()">Senden</button>

    <hr>

    <input id="adminSearchInput" placeholder="Input">
    <button onclick="adminSearch()">OK</button>
    <div id="adminSearchResult"></div>

    <hr>

    <button onclick="loadPlayers()">Spieler verwalten</button>
    <div id="playersList"></div>
  </div>
</div>

<div id="announcements"></div>

<script src="/socket.io/socket.io.js"></script>
<script src="player.js"></script>

<script>
/* =================================================
   BASIS
   ================================================= */
const socket = io();

const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const loginBtn = document.getElementById("loginBtn");
const registerBtn = document.getElementById("registerBtn");

let email = "";
let isAdmin = false;
let adminUnlocked = false;

const foundSet = new Set(); // NEU: Für Found Items ohne Duplikate

/* =================================================
   EMAIL CHECK
   ================================================= */
emailInput.addEventListener("input", ()=>{
  if(!emailInput.value) return;

  fetch("/checkEmail",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ email: emailInput.value })
  })
  .then(r=>r.json())
  .then(d=>{
    loginBtn.style.display = d.exists ? "inline" : "none";
    registerBtn.style.display = d.exists ? "none" : "inline";
  });
});

/* =================================================
   REGISTER
   ================================================= */
registerBtn.onclick = ()=>{
  fetch("/register",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      email: emailInput.value,
      password: passwordInput.value
    })
  })
  .then(r=>r.json())
  .then(d=>{
    if(d.ok){
      enterGame(d.admin);
    } else {
      alert("Registrierung fehlgeschlagen");
    }
  });
};

/* =================================================
   LOGIN
   ================================================= */
loginBtn.onclick = ()=>{
  fetch("/login",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      email: emailInput.value,
      password: passwordInput.value
    })
  })
  .then(r=>r.json())
  .then(d=>{
    if(d.ok){
      enterGame(d.admin);
    } else {
      alert("Falsches Passwort");
    }
  });
};

/* =================================================
   ENTER GAME
   ================================================= */
function enterGame(admin){
  email = emailInput.value;
  isAdmin = admin || email === "till.behner@icloud.com";
  adminUnlocked = false;

  document.getElementById("login").style.display="none";
  document.getElementById("game").style.display="flex";

  if(isAdmin){
    document.getElementById("adminBtn").style.display="inline";
  }

  initPlayer(email);

  emailInput.value="";
  passwordInput.value="";
}

/* =================================================
   LOGOUT
   ================================================= */
function logout(){
  socket.emit("player:offline",{ email });
  location.reload();
}

/* =================================================
   WORD FINDER
   ================================================= */
function submitItem(){
  const input = document.getElementById("word").value.trim();
  if(!input) return;

  fetch("/submitItem",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ email, input })
  })
  .then(r=>r.json())
  .then(d=>{
    if(!d.ok) return;

    const key = d.input + "->" + d.output;
    if(foundSet.has(key)) return; // NEU: kein Duplikat
    foundSet.add(key);

    notifyItemFound(d.input, d.output);

    const div = document.createElement("div");
    div.className="foundItem";
    div.innerHTML =
      d.input+" → "+d.output+
      (d.firstDiscovery ? " <span class='first'>(First Discovery)</span>" : "");

    document.getElementById("foundItems").prepend(div);
    document.getElementById("word").value="";
  });
}

function toggleFound(){
  const f=document.getElementById("foundItems");
  f.style.display = f.style.display==="none"?"block":"none";
}

/* =================================================
   ADMIN
   ================================================= */
function askAdminPassword(){
  if(adminUnlocked){
    adminPanel.style.display =
      adminPanel.style.display==="none"?"block":"none";
    return;
  }

  const pw = prompt("Admin Passwort:");
  if(pw==="X9$QvR7!eM2#A8wK@C"){
    adminUnlocked=true;
    document.getElementById("adminPanel").style.display="block";
  } else {
    alert("Falsches Passwort");
  }
}

/* =================================================
   ANNOUNCEMENTS
   ================================================= */
function sendAnnouncement(){
  if(!adminUnlocked) return;
  const text=document.getElementById("announceText").value;
  socket.emit("adminAnnouncement",{text});
  document.getElementById("announceText").value="";
}

socket.on("announcement",data=>{
  const ann=document.createElement("div");
  ann.className="announcement";
  ann.textContent=data.text;
  document.getElementById("announcements").appendChild(ann);
  setTimeout(()=>ann.remove(),5000);
});

/* =================================================
   ADMIN SEARCH
   ================================================= */
function adminSearch(){
  const query=document.getElementById("adminSearchInput").value;

  fetch("/adminSearch",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ query })
  })
  .then(r=>r.json())
  .then(d=>{
    if(d.ok){
      document.getElementById("adminSearchResult").textContent =
        d.input+" → "+d.output;
    }
  });
}

/* =================================================
   SPIELER VERWALTEN
   ================================================= */
function loadPlayers(){
  socket.emit("admin:getPlayers");
}

socket.on("admin:playersList",(players)=>{
  const list=document.getElementById("playersList");
  list.innerHTML="";
  players.forEach(p=>{
    const div=document.createElement("div");
    div.textContent=p.email;
    div.onclick=()=>alert("Spieler: "+p.email);
    list.appendChild(div);
  });
});

/* =================================================
   BAN SCREEN
   ================================================= */
socket.on("player:banned",(data)=>{
  document.body.innerHTML=`
    <div style="color:red;text-align:center;margin-top:40px">
      <h2>Du wurdest gebannt</h2>
      <p>${data.reason || ""}</p>
    </div>
  `;
});
</script>

</body>
</html>
