<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Word Finder Game</title>
<style>
body { font-family: Arial; margin:0; padding:0; background:#111; color:#eee; }
#game { width:100vw; height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:flex-start; padding:20px; box-sizing:border-box; }
input, button { font-size:16px; padding:6px; margin:5px; }
#foundItems, #adminPanel { border:1px solid #0f0; padding:10px; margin-top:10px; max-height:200px; overflow-y:auto; background:#000; color:#0f0; width:90%; }
.announcement { background:#fff; color:#000; padding:4px 6px; margin:3px 0; }
</style>
</head>
<body>

<div id="loginMenu">
  <input id="email" placeholder="E-Mail">
  <input id="password" type="password" placeholder="Passwort">
  <button id="registerBtn" onclick="register()">Registrieren</button>
  <button id="loginBtn" onclick="login()">Login</button>
</div>

<div id="game" style="display:none;">
  <button onclick="logout()">Logout</button>
  <div>
    <input id="word" placeholder="Wort eingeben">
    <button onclick="submitItem()">OK</button>
  </div>
  <div id="foundItems"></div>

  <button id="adminBtn" style="display:none;" onclick="toggleAdmin()">Admin</button>

  <div id="adminPanel" style="display:none;">
    <h3>Admin Dashboard</h3>
    <div>
      <input id="adminSearchInput" placeholder="Output suchen">
      <button onclick="adminSearch()">OK</button>
      <div id="adminSearchResult"></div>
    </div>
    <div>
      <input id="announceText" placeholder="Ankündigung">
      <button onclick="announce()">Senden</button>
    </div>
  </div>

  <div id="announcements"></div>
</div>

<script>
let email = "", isAdmin = false;
let foundItems = {};

function checkEmail(){
  const e = document.getElementById("email").value;
  fetch("/check-email",{method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({email:e})})
  .then(r=>r.json()).then(d=>{
    if(d.exists){
      document.getElementById("loginBtn").style.display="inline";
      document.getElementById("registerBtn").style.display="none";
    } else {
      document.getElementById("loginBtn").style.display="none";
      document.getElementById("registerBtn").style.display="inline";
    }
  });
}

document.getElementById("email").addEventListener("input", checkEmail);

function register(){
  const e=document.getElementById("email").value;
  const p=document.getElementById("password").value;
  fetch("/register",{method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({email:e,password:p})})
  .then(r=>r.json()).then(d=>{
    if(d.ok){startGame(d.admin);}
    else alert(d.msg || "Fehler beim Registrieren");
  });
}

function login(){
  const e=document.getElementById("email").value;
  const p=document.getElementById("password").value;
  fetch("/login",{method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({email:e,password:p})})
  .then(r=>r.json()).then(d=>{
    if(d.ok){startGame(d.admin);}
    else alert(d.msg || "Falsches Passwort");
  });
}

function logout(){
  fetch("/logout",{method:"POST"}).then(()=>location.reload());
}

function startGame(admin){
  email=document.getElementById("email").value;
  isAdmin=admin;
  document.getElementById("loginMenu").style.display="none";
  document.getElementById("game").style.display="flex";
  document.getElementById("word").value="";
  if(isAdmin) document.getElementById("adminBtn").style.display="inline";
}

// --- Found Items ---
function submitItem(){
  const w = document.getElementById("word").value;
  if(!w) return;
  document.getElementById("word").value=""; // sofort löschen

  fetch("/submit-item",{method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({input:w, output:w})})
  .then(r=>r.json()).then(d=>{
    if(d.ok){
      foundItems[w]=d.output;
      renderFound();
      // unter dem Eingabefeld kurz anzeigen
      const temp = document.createElement("div");
      temp.textContent=`${w} -> ${d.output}`;
      document.getElementById("foundItems").prepend(temp);
      setTimeout(()=>temp.remove(),3000);
    }
  });
}

function renderFound(){
  const f=document.getElementById("foundItems");
  f.innerHTML="";
  for(let i in foundItems){
    const div=document.createElement("div");
    div.textContent=`${i} -> ${foundItems[i]}`;
    f.appendChild(div);
  }
}

// --- Admin Panel ---
function toggleAdmin(){
  const a=document.getElementById("adminPanel");
  a.style.display=a.style.display==="none"?"block":"none";
}

// Admin-Suche
function adminSearch(){
  const output=document.getElementById("adminSearchInput").value;
  if(!output) return;
  fetch("/admin-search",{method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({output})})
  .then(r=>r.json()).then(d=>{
    if(d.ok){
      const resDiv=document.getElementById("adminSearchResult");
      resDiv.innerHTML="";
      const rDiv=document.createElement("div");
      rDiv.textContent=`${d.input} -> ${d.output}`;
      rDiv.style.cursor="pointer";
      rDiv.onclick=()=>{
        const newInput=prompt("Neuer Input:", d.input);
        if(newInput && newInput!==d.input){
          fetch("/admin-update-input",{method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({oldInput:d.input,newInput})})
          .then(r=>r.json()).then(up=>{
            if(up.ok){ rDiv.textContent=`${newInput} -> ${d.output}`; fetchData(); }
          });
        }
      };
      resDiv.appendChild(rDiv);
    }
  });
}

// Admin-Ankündigungen
function announce(){
  const text=document.getElementById("announceText").value;
  if(!text) return;
  document.getElementById("announceText").value="";
  fetch("/admin-announcement",{method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({text})})
  .then(r=>r.json()).then(d=>{
    if(d.ok){ showAnnouncements(); }
  });
}

// Alle Spieler holen Ankündigungen
function showAnnouncements(){
  fetch("/get-announcements")
  .then(r=>r.json())
  .then(data=>{
    const annDiv=document.getElementById("announcements");
    annDiv.innerHTML="";
    data.forEach(a=>{
      const d=document.createElement("div");
      d.className="announcement";
      d.textContent=a.text;
      annDiv.appendChild(d);
    });
  });
}

setInterval(showAnnouncements,1000); // regelmäßig aktualisieren

// optional: holt Found Items neu, wenn Admin Input ändert
function fetchData(){
  for(let key in foundItems){
    // könnte hier evtl. vom Server geholt werden
  }
}
</script>

</body>
</html>
