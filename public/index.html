<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Word Finder Game</title>
<style>
body { font-family: Arial; margin:0; padding:0; overflow:hidden; background:#111; color:#eee; }
#login, #codeBox, #game, #adminPanel { padding:15px; }
input, button { font-size:16px; margin:5px; padding:5px; }
#foundItems { border:1px solid #444; max-height:200px; overflow-y:auto; padding:5px; background:#222; }
#announcements { position:fixed; top:10px; left:50%; transform:translateX(-50%); width:90%; }
.announcement { background:white; color:black; padding:5px 10px; margin:5px 0; border-radius:4px; }
#adminPanel { display:none; background:#000; color:#0f0; padding:10px; }
</style>
</head>
<body>

<div id="login">
  <h2>Word Finder Game</h2>
  <input id="email" placeholder="E-Mail"><br>
  <input id="password" placeholder="Passwort" type="password"><br>
  <button id="loginBtn" onclick="login()">Login</button>
  <button id="registerBtn" onclick="register()">Registrieren</button>
</div>

<div id="game" style="display:none;">
  <input id="word" placeholder="Wort eingeben">
  <button onclick="submit()">OK</button>
  <button onclick="toggleFound()">Found Items</button>
  <button id="adminBtn" style="display:none;" onclick="adminLogin()">Admin</button>
  <button onclick="logout()">Logout</button>

  <div id="foundItems"></div>
</div>

<div id="adminPanel">
  <h3>Admin Dashboard</h3>
  <input id="adminSearch" placeholder="Admin Suche">
  <button onclick="adminSearchSubmit()">OK</button>
  <div id="adminResults"></div>
  <input id="announceText" placeholder="Ankündigung">
  <button onclick="announce()">Ankündigung senden</button>
</div>

<div id="announcements"></div>

<script>
let email = "";
let isAdmin = false;
let found = [];

// --- Login/Register ---
function register() {
  const e = document.getElementById("email").value;
  const p = document.getElementById("password").value;
  fetch("/register", { method:"POST", headers:{ "Content-Type":"application/json" }, body:JSON.stringify({email:e,password:p})})
  .then(r=>r.json()).then(d=>{
    if(d.ok){ alert("Registriert"); loginSuccess(e,false); }
    else alert(d.msg);
  });
}

function login() {
  const e = document.getElementById("email").value;
  const p = document.getElementById("password").value;
  fetch("/login", { method:"POST", headers:{ "Content-Type":"application/json" }, body:JSON.stringify({email:e,password:p})})
  .then(r=>r.json()).then(d=>{
    if(d.ok){ isAdmin=d.admin; loginSuccess(e,isAdmin); }
    else alert(d.msg);
  });
}

function loginSuccess(e,admin) {
  email = e;
  document.getElementById("login").style.display="none";
  document.getElementById("game").style.display="block";
  found = []; document.getElementById("word").value="";
  if(admin) document.getElementById("adminBtn").style.display="inline";
}

// --- Logout ---
function logout() {
  email=""; isAdmin=false;
  document.getElementById("login").style.display="block";
  document.getElementById("game").style.display="none";
  document.getElementById("word").value="";
  document.getElementById("password").value="";
}

// --- Game ---
function submit() {
  const w=document.getElementById("word").value;
  if(!w) return;
  fetch("/find",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email,input:w})})
  .then(r=>r.json()).then(d=>{
    if(d.ok){
      found.push({input:w,output:d.output,first:d.firstBy});
      renderFound();
      document.getElementById("word").value="";
    }
  });
}

function renderFound(){
  const f=document.getElementById("foundItems");
  f.innerHTML=found.map(x=>`${x.input} → ${x.output}${x.first?" (First Discovery)":""}`).join("<br>");
}

function toggleFound(){
  const f=document.getElementById("foundItems");
  f.style.display=f.style.display==="none"?"block":"none";
}

// --- Admin ---
function adminLogin(){
  const p=prompt("Admin Passwort:");
  if(p!== "X9$QvR7!eM2#A8wK@C"){ alert("Falsches Admin Passwort"); return; }
  document.getElementById("adminPanel").style.display="block";
}

function adminSearchSubmit(){
  const q=document.getElementById("adminSearch").value;
  if(!q) return;
  fetch("/admin/find",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:q})})
  .then(r=>r.json()).then(d=>{
    if(d.ok){
      const rdiv=document.getElementById("adminResults");
      rdiv.innerHTML=`${d.input} → ${d.output}`;
      rdiv.onclick=()=>changeInput(d.input);
    }
  });
}

function changeInput(oldInput){
  const newInput=prompt("Neuer Input für dieses Ergebnis:");
  if(!newInput) return;
  fetch("/admin/change",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({oldInput,newInput})})
  .then(r=>r.json()).then(d=>{
    if(d.ok){
      alert("Input geändert");
      // Update Found Items für alle Spieler
    }
  });
}

function announce(){
  const t=document.getElementById("announceText").value;
  if(!t) return;
  fetch("/admin/announce",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:t})})
  .then(r=>r.json()).then(d=>{
    if(d.ok){
      const div=document.createElement("div");
      div.className="announcement"; div.textContent=d.text;
      document.getElementById("announcements").appendChild(div);
      setTimeout(()=>div.remove(),5000);
      document.getElementById("announceText").value="";
    }
  });
}
</script>

</body>
</html>
